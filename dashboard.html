<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BHC Library - Dashboard</title>

  <!-- Chart.js & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  /* ------- YOUR ORIGINAL STYLES (kept mostly intact) ------- */
  body { 
    margin: 0; 
    font-family: 'Segoe UI', sans-serif; 
    background: #f4f6f9; 
    transition: background 0.3s, color 0.3s;
  }

  /* HEADER */
  header {
    position: fixed;   
    top: 0;
    left: 0;
    width: 100%;
    height: 65px;
    background: linear-gradient(90deg, #8B1C3D, #2B4B9C);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px; /* fixed para kita logout */
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    z-index: 1000;
  }
  header .header-left { display: flex; align-items: center; }
  header img { 
    width: 50px; 
    margin-right: 15px; 
    transition: transform 0.3s ease, filter 0.3s ease;
  }
  header img:hover { 
    transform: scale(1.1);
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.7));
  }
  header h1 { margin: 0; font-size: 22px; font-weight: 600; }

 /* Right section (logout + dark mode + notif + user) */
.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-right: 20px; /* adjusted spacing so logout not outside */
}

/* Notifications (bell + badge + dropdown) */
.notif-btn {
  background: transparent;
  border: none;
  color: white;
  font-size: 18px;
  position: relative;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
}
.notif-btn:hover { background: rgba(255,255,255,0.06); }

.notif-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  background: #e74c3c;
  color: white;
  padding: 2px 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
}

/* notif dropdown */
.notif-dropdown {
  position: absolute;
  right: 20px;
  top: 65px;
  width: 300px;
  max-height: 320px;
  overflow-y: auto;
  background: white;
  color: black;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  display: none;
  z-index: 1500;
}
.notif-dropdown .title {
  padding: 10px 12px; border-bottom: 1px solid #eee; font-weight: 700;
}
.notif-dropdown ul { list-style: none; margin: 0; padding: 0; }
.notif-dropdown li { padding: 10px 12px; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
.notif-dropdown li:last-child { border-bottom: none; }
.notif-dropdown .empty { padding: 12px; color: #888; }

/* small user label */
.header-user {
  color: #fff; font-size: 14px; padding: 6px 10px; border-radius: 8px; background: rgba(255,255,255,0.06);
}

/* Buttons (Logout + Dark Mode) */
header button {
  background: #c0392b;
  border: none;
  padding: 10px 18px;
  color: white;
  border-radius: 30px;  
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
  white-space: nowrap;
}
header button:hover { 
  background: #922b21; 
  transform: scale(1.05);
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

/* Dark mode toggle button */
#darkToggle {
  background: #2B4B9C;
  border: none;
  padding: 10px 14px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}
#darkToggle:hover {
  background: #8B1C3D;
  transform: rotate(20deg) scale(1.1);
}

/* SIDEBAR */
.sidebar {
  position: fixed;
  top: 65px;
  left: 0;
  width: 220px;
  height: calc(100% - 65px);
  background: #2B4B9C;
  color: white;
  padding-top: 20px;
  box-shadow: 3px 0 6px rgba(0,0,0,0.2);
  overflow-y: auto;
  transition: background 0.3s;
}
.sidebar a {
  color: white;
  text-decoration: none;
  display: block;
  padding: 14px 20px;
  margin: 8px 12px;
  font-weight: 500;
  border-radius: 10px;
  transition: all 0.3s ease;
}
.sidebar a:hover, .sidebar a.active { 
  background: #8B1C3D; 
  transform: translateX(5px);
}

/* MAIN */
main { 
  margin-left: 240px;
  margin-top: 80px;
  padding: 25px;
  transition: color 0.3s, background 0.3s;
}
section { display: none; }
section.active { display: block; animation: fadeIn 0.4s ease; }
h2 { color: #2B4B9C; margin-bottom: 15px; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Forms */
form input, form select, form button {
  padding: 10px; 
  margin: 5px; 
  border-radius: 6px; 
  border: 1px solid #ccc;
}
form button {
  background: #2B4B9C; 
  color: white; 
  cursor: pointer; 
  border: none; 
  font-weight: bold;
  border-radius: 6px;
  transition: background 0.3s ease;
}
form button:hover { background: #8B1C3D; }

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: background 0.3s, color 0.3s;
}
th, td {
  padding: 12px;
  border: 1px solid #ddd;
  text-align: left;
}
th {
  background: #8B1C3D;
  color: white;
}
button.delete, button.edit {
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  color: white;
  transition: transform 0.2s ease;
}
button.delete { background: #e74c3c; }
button.delete:hover { background: #c0392b; transform: scale(1.05); }
button.edit { background: #2980b9; }
button.edit:hover { background: #1f618d; transform: scale(1.05); }

/* Cards */
.stats {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.stat-box {
  flex: 1;
  min-width: 200px;
  padding: 20px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  text-align: center;
  transition: transform 0.2s, background 0.3s, color 0.3s;
}
.stat-box:hover { transform: scale(1.05); }
.stat-box h3 { margin: 0; color: #2B4B9C; font-size: 16px; }
.stat-box p { font-size: 26px; font-weight: bold; margin: 8px 0 0; color: #8B1C3D; }

/* Buttons */
.export-btn {
  margin: 10px 5px 20px 0;
  background: #27ae60;
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}
.export-btn:hover { background: #1e8449; transform: scale(1.05); }

/* Reports */
#reportChart {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  margin: 20px 0;
  transition: background 0.3s;
}
.overdue-list li {
  color: red;
  font-weight: bold;
}

/* Scrollbar design */
::-webkit-scrollbar {
  width: 10px;
}
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #2B4B9C; border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: #8B1C3D; }

/* Footer */
footer {
  text-align: center;
  padding: 12px;
  color: #666;
  font-size: 13px;
  margin-top: 30px;
}

/* DARK MODE üåô */
body.dark {
  background: #181818;
  color: #f5f5f5;
}
body.dark main h2,
body.dark .stat-box h3 {
  color: #f5f5f5;
}
body.dark .stat-box { background: #2a2a2a; color: #fff; }
body.dark table { background: #2a2a2a; color: #eee; }
body.dark th { background: #444; color: #fff; }
body.dark .sidebar { background: #1f1f1f; }

/* Forms Dark Mode */
body.dark input, body.dark select, body.dark textarea {
  background: #2a2a2a;
  color: #f5f5f5;
  border: 1px solid #555;
}
body.dark input::placeholder, body.dark textarea::placeholder { color: #aaa; }
body.dark form button { background: #444; color: #fff; }
body.dark form button:hover { background: #666; }
body.dark .sidebar a.active { background: #444; }
body.dark footer { color: #aaa; }

/* Smooth transition effect */
body, main, table, .stat-box, .sidebar, header {
  transition: background 0.3s, color 0.3s;
}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="assets/bhc-logo.png" alt="BHC Logo">
    <h1>BHC Library System</h1>
  </div>

  <div class="header-right">
    <!-- notification bell -->
    <button class="notif-btn" id="notifBtn" title="Notifications">üîî
      <span class="notif-badge" id="notifBadge" style="display:none">0</span>
    </button>
    <div class="notif-dropdown" id="notifDropdown">
      <div class="title">Notifications</div>
      <ul id="notifList"><li class="empty">No notifications</li></ul>
    </div>

    <div class="header-user" id="headerUser">Guest</div>

    <button id="darkToggle">üåô</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<nav class="sidebar" id="sidebarNav">
  <a href="#" onclick="showSection('dashboard')" data-section="dashboard" class="active">üìä Dashboard</a>
  <a href="#" onclick="showSection('books')" data-section="books">üìö Books</a>
  <a href="#" onclick="showSection('borrowers')" data-section="borrowers">üë• Borrowers</a>
  <a href="#" onclick="showSection('transactions')" data-section="transactions">üìë Transactions</a>
  <a href="#" onclick="showSection('admins')" data-section="admins">‚öô Admin Accounts</a>
  <a href="#" onclick="showSection('reports')" data-section="reports">üìà Reports</a>
</nav>

<main>
  <!-- Dashboard -->
  <section id="dashboard" class="active">
    <h2>üìä Summary</h2>
    <div class="stats">
      <div class="stat-box"><h3>Total Books</h3><p id="statBooks">0</p></div>
      <div class="stat-box"><h3>Borrowed</h3><p id="statBorrowed">0</p></div>
      <div class="stat-box"><h3>Available</h3><p id="statAvailable">0</p></div>
      <div class="stat-box"><h3>Overdue</h3><p id="statOverdue">0</p></div>
    </div>
  </section>

  <!-- Books -->
  <section id="books">
    <h2>üìö Books Collection</h2>
    <form id="bookForm">
      <input type="hidden" id="editBookIndex">
      <input type="text" id="bookTitle" placeholder="Book Title" required>
      <input type="text" id="bookAuthor" placeholder="Author" required>
      <input type="text" id="bookCategory" placeholder="Category">
      <button type="submit">‚ûï Add / Update Book</button>
    </form>
    <div style="margin-top:8px;">
      <input type="text" id="searchBook" class="search-box" placeholder="üîç Search Book..." style="width:60%;">
      <select id="filterCategory" style="margin-left:8px; padding:8px; border-radius:6px;">
        <option value="">All categories</option>
      </select>
    </div>
    <table>
      <thead><tr><th>Title</th><th>Author</th><th>Category</th><th>Status</th><th>Action</th></tr></thead>
      <tbody id="bookList"></tbody>
    </table>
  </section>

  <!-- Borrowers -->
  <section id="borrowers">
    <h2>üë• Borrowers</h2>
    <form id="borrowerForm">
      <input type="hidden" id="editBorrowerIndex">
      <input type="text" id="borrowerName" placeholder="Borrower Name" required>
      <input type="text" id="borrowerID" placeholder="Student ID" required>
      <input type="text" id="borrowerCourse" placeholder="Course/Year" required>
      <button type="submit">‚ûï Add / Update Borrower</button>
    </form>
    <table>
      <thead><tr><th>Name</th><th>ID</th><th>Course</th><th>History</th><th>Action</th></tr></thead>
      <tbody id="borrowerList"></tbody>
    </table>
  </section>

  <!-- Transactions -->
  <section id="transactions">
    <h2>üìë Transactions</h2>
    <form id="transactionForm">
      <select id="transactionBorrower" required style="min-width:200px;"></select>
      <select id="transactionBook" required style="min-width:200px;"></select>
      <button type="submit">üìñ Borrow</button>
      <button type="button" id="returnBtn">‚Ü© Return</button>
    </form>
    <ul id="transactionList" style="margin-top:12px;"></ul>
  </section>

  <!-- Admin Accounts -->
  <section id="admins">
    <h2>‚öô Manage Admin Accounts</h2>
    <form id="adminForm">
      <input type="text" id="adminUsername" placeholder="Username" required>
      <input type="password" id="adminPassword" placeholder="Password" required>
      <select id="adminRole" required>
        <option value="Super Admin">Super Admin</option>
        <option value="Librarian">Librarian</option>
        <option value="Staff">Staff</option>
        <option value="Viewer">Viewer</option>
      </select>
      <button type="submit">‚ûï Add Admin</button>
    </form>
    <table>
      <thead><tr><th>Username</th><th>Role</th><th>Action</th></tr></thead>
      <tbody id="adminList"></tbody>
    </table>
  </section>

  <!-- Reports -->
  <section id="reports">
    <h2>üìä Reports</h2>
    <div class="stats">
      <div class="stat-box"><h3>Total Borrowers</h3><p id="statTotalBorrowers">0</p></div>
      <div class="stat-box"><h3>Total Transactions</h3><p id="statTotalTransactions">0</p></div>
      <div class="stat-box"><h3>Returned</h3><p id="statReturned">0</p></div>
      <div class="stat-box"><h3>Overdue</h3><p id="statReportOverdue">0</p></div>
    </div>
    <h3>‚ö† Overdue Books</h3>
    <ul id="overdueList"></ul>
    <h3>Borrowed vs Returned (Monthly)</h3>
    <canvas id="reportChart" style="max-width:600px;"></canvas>
    <div style="margin-top:12px;">
      <button class="export-btn" onclick="exportTransactions()">‚¨á Export CSV</button>
      <button class="export-btn" onclick="exportPDF()">‚¨á Export PDF</button>
      <button class="export-btn" onclick="exportJSON()">üíæ Backup JSON</button>
      <input type="file" id="importFile" accept=".json" onchange="importJSON(event)">
    </div>
  </section>
</main>

<footer>¬© 2025 BHC Library System</footer>

<script>
/* ======================
   Data + Persistence
   ====================== */
function saveData(){
  localStorage.setItem('books', JSON.stringify(books));
  localStorage.setItem('borrowers', JSON.stringify(borrowers));
  localStorage.setItem('transactions', JSON.stringify(transactions));
  localStorage.setItem('admins', JSON.stringify(admins));
  // store currently logged admin too
  localStorage.setItem('loggedInAdmin', JSON.stringify(loggedInAdmin));
}

/* Load from storage or initialize */
let books = JSON.parse(localStorage.getItem('books')) || [];
let borrowers = JSON.parse(localStorage.getItem('borrowers')) || [];
let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
let admins = JSON.parse(localStorage.getItem('admins')) || [{ username: "admin", password: "admin123", role: "Super Admin" }];

/* loggedInAdmin: stored {username, role} in localStorage.loggedInAdmin
   For this dashboard file: if not present, set default to first admin */
let loggedInAdmin = JSON.parse(localStorage.getItem('loggedInAdmin')) || (admins.length ? { username: admins[0].username, role: admins[0].role } : { username: 'guest', role: 'Viewer' });
localStorage.setItem('loggedInAdmin', JSON.stringify(loggedInAdmin));

/* =======================
   Role-based UI helpers
   ======================= */
function applyRolePermissions(){
  // Tab permissions map
  const perms = {
    "Super Admin": ['dashboard','books','borrowers','transactions','admins','reports'],
    "Librarian": ['dashboard','books','borrowers','transactions','reports'],
    "Staff": ['dashboard','books','borrowers','transactions'],
    "Viewer": ['dashboard','reports']
  };
  const allowed = perms[loggedInAdmin.role] || [];
  // show/hide sidebar links
  document.querySelectorAll('.sidebar a').forEach(a=>{
    const sec = a.getAttribute('data-section');
    if(allowed.includes(sec)) {
      a.style.display = 'block';
    } else {
      a.style.display = 'none';
      // if currently active section is hidden, switch to dashboard
      if(a.classList.contains('active')) a.classList.remove('active');
    }
  });
  // if active section is hidden or none active, show dashboard
  const active = document.querySelector('.sidebar a.active');
  if(!active || active.style.display === 'none'){
    const dashLink = document.querySelector('.sidebar a[data-section="dashboard"]');
    dashLink.classList.add('active');
    showSection('dashboard');
  }
  // header user label
  document.getElementById('headerUser').textContent = loggedInAdmin.username + " ‚Äî " + loggedInAdmin.role;
}

/* =======================
   Navigation + UI helpers
   ======================= */
function showSection(id) {
  // hide all sections
  document.querySelectorAll('main section').forEach(s => s.classList.remove('active'));
  // add active
  const sec = document.getElementById(id);
  if(sec) sec.classList.add('active');
  // update sidebar active
  document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
  const link = document.querySelector(`.sidebar a[data-section="${id}"]`);
  if(link) link.classList.add('active');
  // update stats / chart when needed
  if(id === 'reports') renderReports();
}
/* Handle clicking sidebar links that are anchor tags */
document.querySelectorAll('.sidebar a').forEach(a=>{
  a.addEventListener('click', (e) => {
    e.preventDefault();
    const sec = a.getAttribute('data-section');
    // only allow clicking if visible (role)
    if(a.style.display === 'none') return;
    showSection(sec);
  });
});

/* =======================
   BOOKS (with categories + filter)
   ======================= */
const bookListEl = document.getElementById('bookList');
const filterCategoryEl = document.getElementById('filterCategory');

function renderBooks(filter = "") {
  // build categories set
  const categories = new Set();
  bookListEl.innerHTML = '';
  const catFilter = filterCategoryEl.value || '';
  books.filter(b => {
    const matchesText = (b.title || '').toLowerCase().includes(filter.toLowerCase()) || (b.author || '').toLowerCase().includes(filter.toLowerCase());
    const matchesCat = !catFilter || (b.category === catFilter);
    return matchesText && matchesCat;
  }).forEach((book, index) => {
    if(book.category) categories.add(book.category);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${book.title}</td>
      <td>${book.author}</td>
      <td>${book.category || '-'}</td>
      <td>${book.status || 'Available'}</td>
      <td>
        <button class="edit">‚úè Edit</button>
        <button class="delete">üóë Delete</button>
      </td>
    `;
    row.querySelector('.delete').addEventListener('click', () => {
      if(!confirm('Delete this book?')) return;
      books.splice(index, 1);
      saveData(); renderBooks(); updateStats();
    });
    row.querySelector('.edit').addEventListener('click', () => {
      document.getElementById('bookTitle').value = book.title;
      document.getElementById('bookAuthor').value = book.author;
      document.getElementById('bookCategory').value = book.category || '';
      document.getElementById('editBookIndex').value = index;
    });
    bookListEl.appendChild(row);
  });

  // populate filterCategory
  filterCategoryEl.innerHTML = '<option value="">All categories</option>';
  Array.from(categories).sort().forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
    filterCategoryEl.appendChild(opt);
  });

  updateTransactionBooks();
  updateStats();
}

document.getElementById('bookForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const title = document.getElementById('bookTitle').value.trim();
  const author = document.getElementById('bookAuthor').value.trim();
  const category = document.getElementById('bookCategory').value.trim();
  const idx = document.getElementById('editBookIndex').value;
  if(idx) {
    books[idx] = { ...books[idx], title, author, category };
    document.getElementById('editBookIndex').value = '';
  } else {
    books.push({ title, author, category, status: 'Available' });
  }
  saveData();
  renderBooks();
  e.target.reset();
});

document.getElementById('searchBook').addEventListener('input', (e) => renderBooks(e.target.value));
filterCategoryEl.addEventListener('change', () => renderBooks(document.getElementById('searchBook').value || ''));

/* =======================
   BORROWERS (with history)
   ======================= */
const borrowerListEl = document.getElementById('borrowerList');

function renderBorrowers() {
  borrowerListEl.innerHTML = '';
  borrowers.forEach((b, index) => {
    // build small history text
    const history = transactions.filter(t => t.borrower === b.name).map(t => `${t.book} (${t.type})`).join(', ');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${b.name}</td>
      <td>${b.id}</td>
      <td>${b.course}</td>
      <td style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${history || '-'}">${history || '-'}</td>
      <td>
        <button class="edit">‚úè Edit</button>
        <button class="delete">üóë Remove</button>
      </td>
    `;
    row.querySelector('.delete').addEventListener('click', () => {
      if(!confirm('Remove borrower?')) return;
      borrowers.splice(index,1); saveData(); renderBorrowers(); updateTransactionBorrowers();
    });
    row.querySelector('.edit').addEventListener('click', () => {
      document.getElementById('borrowerName').value = b.name;
      document.getElementById('borrowerID').value = b.id;
      document.getElementById('borrowerCourse').value = b.course;
      document.getElementById('editBorrowerIndex').value = index;
    });
    borrowerListEl.appendChild(row);
  });
  updateTransactionBorrowers();
  updateStats();
}

document.getElementById('borrowerForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const name = document.getElementById('borrowerName').value.trim();
  const id = document.getElementById('borrowerID').value.trim();
  const course = document.getElementById('borrowerCourse').value.trim();
  const idx = document.getElementById('editBorrowerIndex').value;
  if(idx) {
    borrowers[idx] = { name, id, course };
    document.getElementById('editBorrowerIndex').value = '';
  } else {
    borrowers.push({ name, id, course });
  }
  saveData(); renderBorrowers(); e.target.reset();
});

/* =======================
   TRANSACTIONS
   ======================= */
const transactionListEl = document.getElementById('transactionList');

function renderTransactions() {
  transactionListEl.innerHTML = '';
  transactions.slice().reverse().forEach(t => { // show latest first
    const li = document.createElement('li');
    const dueText = t.dueDate ? ` (Due: ${t.dueDate})` : '';
    li.textContent = `${t.borrower} ${t.type} "${t.book}" on ${t.date}${dueText}`;
    if(t.type === 'borrowed' && new Date(t.dueDate) < new Date() && !t.returned) {
      li.style.color = 'red';
      li.textContent += ' ‚ö† Overdue!';
    }
    transactionListEl.appendChild(li);
  });
  updateStats();
}

function updateTransactionBorrowers() {
  const select = document.getElementById('transactionBorrower');
  select.innerHTML = '';
  borrowers.forEach(b => {
    const opt = document.createElement('option'); opt.value = b.name; opt.textContent = `${b.name} (${b.id})`;
    select.appendChild(opt);
  });
}

function updateTransactionBooks() {
  const select = document.getElementById('transactionBook');
  select.innerHTML = '';
  books.forEach(b => {
    if(b.status === 'Available' || !b.status) {
      const opt = document.createElement('option'); opt.value = b.title; opt.textContent = b.title;
      select.appendChild(opt);
    }
  });
}

document.getElementById('transactionForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const borrower = document.getElementById('transactionBorrower').value;
  const bookTitle = document.getElementById('transactionBook').value;
  if(!borrower || !bookTitle) { alert('Select borrower and book'); return; }
  const date = new Date().toLocaleDateString();
  const due = new Date(); due.setDate(due.getDate() + 7);
  transactions.push({ borrower, book: bookTitle, type: 'borrowed', date, dueDate: due.toLocaleDateString(), returned: false });
  // set book status
  books = books.map(b => b.title === bookTitle ? { ...b, status: 'Borrowed' } : b);
  saveData(); renderTransactions(); renderBooks(); renderBorrowers();
});

document.getElementById('returnBtn').addEventListener('click', () => {
  const borrower = document.getElementById('transactionBorrower').value;
  const bookTitle = document.getElementById('transactionBook').value;
  if(!borrower || !bookTitle) { alert('Select borrower and book'); return; }
  // find latest borrowed transaction not returned for that pair
  for(let i = transactions.length-1; i>=0; i--){
    const t = transactions[i];
    if(t.borrower === borrower && t.book === bookTitle && !t.returned && t.type === 'borrowed'){
      transactions.push({ borrower, book: bookTitle, type: 'returned', date: new Date().toLocaleDateString(), returned: true });
      transactions[i].returned = true; // mark earlier record
      break;
    }
  }
  books = books.map(b => b.title === bookTitle ? { ...b, status: 'Available' } : b);
  saveData(); renderTransactions(); renderBooks();
});

/* =======================
   EXPORT / BACKUP / RESTORE
   ======================= */
function exportTransactions() {
  let csv = "Borrower,Book,Type,Date,Due Date\n";
  transactions.forEach(t => {
    csv += `${t.borrower},${t.book},${t.type},${t.date},${t.dueDate || ""}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "transactions.csv"; a.click();
  URL.revokeObjectURL(url);
}

function exportPDF() {
  const doc = new jspdf.jsPDF();
  doc.text("BHC Library - Transactions Report", 20, 20);
  let rows = transactions.map(t => [t.borrower, t.book, t.type, t.date, t.dueDate || ""]);
  doc.autoTable({ head: [["Borrower","Book","Type","Date","Due Date"]], body: rows, startY: 30 });
  doc.save("transactions_report.pdf");
}

function exportJSON() {
  const data = { books, borrowers, transactions, admins };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'library_backup.json'; a.click();
  URL.revokeObjectURL(url);
}

function importJSON(event) {
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      books = data.books || []; borrowers = data.borrowers || []; transactions = data.transactions || []; admins = data.admins || admins;
      // ensure there's always at least one admin
      if(!admins.length) admins = [{ username: "admin", password: "admin123", role: "Super Admin" }];
      // set loggedInAdmin if missing
      if(!loggedInAdmin || !admins.some(a => a.username === loggedInAdmin.username)) {
        loggedInAdmin = { username: admins[0].username, role: admins[0].role };
      }
      saveData();
      alert('Data restored successfully!');
      // re-render everything
      renderBooks(); renderBorrowers(); renderTransactions(); renderAdmins(); applyRolePermissions();
    } catch(err) {
      alert('Invalid JSON file.');
      console.error(err);
    }
  };
  reader.readAsText(file);
}

/* =======================
   STATS + REPORTS
   ======================= */
function updateStats() {
  document.getElementById('statBooks').textContent = books.length;
  document.getElementById('statBorrowed').textContent = books.filter(b => b.status === 'Borrowed').length;
  document.getElementById('statAvailable').textContent = books.filter(b => b.status === 'Available' || !b.status).length;
  document.getElementById('statOverdue').textContent = transactions.filter(t => t.type === 'borrowed' && new Date(t.dueDate) < new Date() && !t.returned).length;
  // reports stats
  document.getElementById('statTotalBorrowers').textContent = borrowers.length;
  document.getElementById('statTotalTransactions').textContent = transactions.length;
  document.getElementById('statReturned').textContent = transactions.filter(t => t.type === 'returned' || t.returned).length;
  document.getElementById('statReportOverdue').textContent = transactions.filter(t => t.type === 'borrowed' && new Date(t.dueDate) < new Date() && !t.returned).length;
  // notifications
  updateNotifications();
}

function renderReports() {
  // build overdue list and chart
  const overdueListEl = document.getElementById('overdueList');
  overdueListEl.innerHTML = '';
  const overdue = transactions.filter(t => t.type === 'borrowed' && new Date(t.dueDate) < new Date() && !t.returned);
  overdue.forEach(t => {
    const li = document.createElement('li'); li.textContent = `${t.borrower} - "${t.book}" (Due: ${t.dueDate})`;
    overdueListEl.appendChild(li);
  });

  // monthly chart (approx by date string parsing)
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  let borrowedData = Array(12).fill(0);
  let returnedData = Array(12).fill(0);
  transactions.forEach(t => {
    const d = new Date(t.date);
    if(!isNaN(d)) {
      const m = d.getMonth();
      if(t.type === 'borrowed') borrowedData[m]++;
      if(t.type === 'returned') returnedData[m]++;
    }
  });

  const ctx = document.getElementById('reportChart').getContext('2d');
  if(window.reportChartInstance) window.reportChartInstance.destroy();
  window.reportChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label: 'Borrowed', data: borrowedData, backgroundColor: '#2B4B9C' },
        { label: 'Returned', data: returnedData, backgroundColor: '#8B1C3D' }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

/* =======================
   ADMINS (with roles)
   ======================= */
const adminListEl = document.getElementById('adminList');
function renderAdmins(){
  adminListEl.innerHTML = '';
  admins.forEach((a, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.username}</td><td>${a.role || 'Viewer'}</td>
      <td><button class="delete">üóë Remove</button></td>`;
    tr.querySelector('.delete').addEventListener('click', () => {
      if(!confirm('Remove admin?')) return;
      admins.splice(idx,1); saveData(); renderAdmins(); applyRolePermissions();
    });
    adminListEl.appendChild(tr);
  });
}
document.getElementById('adminForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const username = document.getElementById('adminUsername').value.trim();
  const password = document.getElementById('adminPassword').value;
  const role = document.getElementById('adminRole').value;
  if(!username || !password) return alert('Enter username & password');
  admins.push({ username, password, role });
  saveData(); renderAdmins(); applyRolePermissions();
  e.target.reset();
});

/* =======================
   Notifications
   ======================= */
function updateNotifications(){
  const overdue = transactions.filter(t => t.type === 'borrowed' && new Date(t.dueDate) < new Date() && !t.returned);
  const badge = document.getElementById('notifBadge');
  const list = document.getElementById('notifList');
  list.innerHTML = '';
  if(overdue.length === 0) {
    badge.style.display = 'none';
    list.innerHTML = '<li class="empty">No notifications</li>';
  } else {
    badge.style.display = 'inline-block';
    badge.textContent = overdue.length;
    overdue.forEach(o => {
      const li = document.createElement('li');
      li.textContent = `‚ö† ${o.book} overdue by ${o.borrower} (Due: ${o.dueDate})`;
      list.appendChild(li);
    });
  }
}
/* toggle dropdown */
document.getElementById('notifBtn').addEventListener('click', (e) => {
  const dd = document.getElementById('notifDropdown');
  dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
});
/* close notif dropdown when clicking outside */
document.addEventListener('click', (e) => {
  const dd = document.getElementById('notifDropdown');
  if(!e.target.closest('.notif-btn') && !e.target.closest('.notif-dropdown')) {
    dd.style.display = 'none';
  }
});

/* =======================
   Init & small helpers
   ======================= */
function renderAll(){
  renderBooks();
  renderBorrowers();
  renderTransactions();
  renderAdmins();
  updateStats();
  applyRolePermissions();
}
function renderTransactions(){ /* already defined above earlier ‚Äî ensure same name */
  // we defined earlier; call it
  // but to be safe, re-run logic:
  transactionListEl.innerHTML = '';
  transactions.slice().reverse().forEach(t => {
    const li = document.createElement('li');
    const dueText = t.dueDate ? ` (Due: ${t.dueDate})` : '';
    li.textContent = `${t.borrower} ${t.type} "${t.book}" on ${t.date}${dueText}`;
    if(t.type === 'borrowed' && new Date(t.dueDate) < new Date() && !t.returned) {
      li.style.color = 'red'; li.textContent += ' ‚ö† Overdue!';
    }
    transactionListEl.appendChild(li);
  });
  updateStats();
}

/* dark mode toggle */
document.getElementById('darkToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const btn = document.getElementById('darkToggle');
  btn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
});

/* logout */
document.getElementById('logoutBtn').addEventListener('click', () => {
  // remove loggedInAdmin and go to index/login (if exists)
  localStorage.removeItem('loggedInAdmin');
  alert('Logged out (for demo). Redirecting to index.html if exists.');
  // redirect to index.html (your login)
  window.location.href = 'index.html';
});

/* set current loggedInAdmin display and permissions */
applyRolePermissions();

/* initial render */
renderAll();

/* update notifications periodically (every 15s) to keep badge fresh */
setInterval(updateNotifications, 15000);
updateNotifications();

</script>
</body>
</html>
