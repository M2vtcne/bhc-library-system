<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BHC Library - Dashboard</title>

  <!-- Chart.js & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  /* ------- YOUR ORIGINAL STYLES (kept mostly intact) ------- */
  body { 
    margin: 0; 
    font-family: 'Segoe UI', sans-serif; 
    background: #f4f6f9; 
    transition: background 0.3s, color 0.3s;
  }

  /* HEADER */
  header {
    position: fixed;   
    top: 0;
    left: 0;
    width: 100%;
    height: 65px;
    background: linear-gradient(90deg, #8B1C3D, #2B4B9C);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px; /* fixed para kita logout */
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    z-index: 1000;
  }
  header .header-left { display: flex; align-items: center; }
  header img { 
    width: 50px; 
    margin-right: 15px; 
    transition: transform 0.3s ease, filter 0.3s ease;
  }
  header img:hover { 
    transform: scale(1.1);
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.7));
  }
  header h1 { margin: 0; font-size: 22px; font-weight: 600; }

 /* Right section (logout + dark mode + notif + user) */
.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-right: 20px; /* adjusted spacing so logout not outside */
}

/* Notifications (bell + badge + dropdown) */
.notif-btn {
  background: transparent;
  border: none;
  color: white;
  font-size: 18px;
  position: relative;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
}
.notif-btn:hover { background: rgba(255,255,255,0.06); }

.notif-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  background: #e74c3c;
  color: white;
  padding: 2px 6px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
}

/* notif dropdown */
.notif-dropdown {
  position: absolute;
  right: 20px;
  top: 65px;
  width: 300px;
  max-height: 320px;
  overflow-y: auto;
  background: white;
  color: black;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  display: none;
  z-index: 1500;
}
.notif-dropdown .title {
  padding: 10px 12px; border-bottom: 1px solid #eee; font-weight: 700;
}
.notif-dropdown ul { list-style: none; margin: 0; padding: 0; }
.notif-dropdown li { padding: 10px 12px; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
.notif-dropdown li:last-child { border-bottom: none; }
.notif-dropdown .empty { padding: 12px; color: #888; }

/* small user label */
.header-user {
  color: #fff; font-size: 14px; padding: 6px 10px; border-radius: 8px; background: rgba(255,255,255,0.06);
}

/* Buttons (Logout + Dark Mode) */
header button {
  background: #c0392b;
  border: none;
  padding: 10px 18px;
  color: white;
  border-radius: 30px;  
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
  white-space: nowrap;
}
header button:hover { 
  background: #922b21; 
  transform: scale(1.05);
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}

/* Dark mode toggle button */
#darkToggle {
  background: #2B4B9C;
  border: none;
  padding: 10px 14px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}
#darkToggle:hover {
  background: #8B1C3D;
  transform: rotate(20deg) scale(1.1);
}

/* SIDEBAR */
.sidebar {
  position: fixed;
  top: 65px;
  left: 0;
  width: 220px;
  height: calc(100% - 65px);
  background: #2B4B9C;
  color: white;
  padding-top: 20px;
  box-shadow: 3px 0 6px rgba(0,0,0,0.2);
  overflow-y: auto;
  transition: background 0.3s;
}
.sidebar a {
  color: white;
  text-decoration: none;
  display: block;
  padding: 14px 20px;
  margin: 8px 12px;
  font-weight: 500;
  border-radius: 10px;
  transition: all 0.3s ease;
}
.sidebar a:hover, .sidebar a.active { 
  background: #8B1C3D; 
  transform: translateX(5px);
}

/* MAIN */
main { 
  margin-left: 240px;
  margin-top: 80px;
  padding: 25px;
  transition: color 0.3s, background 0.3s;
}
section { display: none; }
section.active { display: block; animation: fadeIn 0.4s ease; }
h2 { color: #2B4B9C; margin-bottom: 15px; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Forms */
form input, form select, form button {
  padding: 10px; 
  margin: 5px; 
  border-radius: 6px; 
  border: 1px solid #ccc;
}
form button {
  background: #2B4B9C; 
  color: white; 
  cursor: pointer; 
  border: none; 
  font-weight: bold;
  border-radius: 6px;
  transition: background 0.3s ease;
}
form button:hover { background: #8B1C3D; }

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: background 0.3s, color 0.3s;
}
th, td {
  padding: 12px;
  border: 1px solid #ddd;
  text-align: left;
}
th {
  background: #8B1C3D;
  color: white;
}
button.delete, button.edit {
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  color: white;
  transition: transform 0.2s ease;
}
button.delete { background: #e74c3c; }
button.delete:hover { background: #c0392b; transform: scale(1.05); }
button.edit { background: #2980b9; }
button.edit:hover { background: #1f618d; transform: scale(1.05); }

/* Cards */
.stats {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}
.stat-box {
  flex: 1;
  min-width: 200px;
  padding: 20px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  text-align: center;
  transition: transform 0.2s, background 0.3s, color 0.3s;
}
.stat-box:hover { transform: scale(1.05); }
.stat-box h3 { margin: 0; color: #2B4B9C; font-size: 16px; }
.stat-box p { font-size: 26px; font-weight: bold; margin: 8px 0 0; color: #8B1C3D; }

/* Buttons */
.export-btn {
  margin: 10px 5px 20px 0;
  background: #27ae60;
  color: white;
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}
.export-btn:hover { background: #1e8449; transform: scale(1.05); }

/* Reports */
#reportChart {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  margin: 20px 0;
  transition: background 0.3s;
}
.overdue-list li {
  color: red;
  font-weight: bold;
}

/* Scrollbar design */
::-webkit-scrollbar {
  width: 10px;
}
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #2B4B9C; border-radius: 5px; }
::-webkit-scrollbar-thumb:hover { background: #8B1C3D; }

/* Footer */
footer {
  text-align: center;
  padding: 12px;
  color: #666;
  font-size: 13px;
  margin-top: 30px;
}

/* DARK MODE 🌙 */
body.dark {
  background: #181818;
  color: #f5f5f5;
}
body.dark main h2,
body.dark .stat-box h3 {
  color: #f5f5f5;
}
body.dark .stat-box { background: #2a2a2a; color: #fff; }
body.dark table { background: #2a2a2a; color: #eee; }
body.dark th { background: #444; color: #fff; }
body.dark .sidebar { background: #1f1f1f; }

/* Forms Dark Mode */
body.dark input, body.dark select, body.dark textarea {
  background: #2a2a2a;
  color: #f5f5f5;
  border: 1px solid #555;
}
body.dark input::placeholder, body.dark textarea::placeholder { color: #aaa; }
body.dark form button { background: #444; color: #fff; }
body.dark form button:hover { background: #666; }
body.dark .sidebar a.active { background: #444; }
body.dark footer { color: #aaa; }

/* Smooth transition effect */
body, main, table, .stat-box, .sidebar, header {
  transition: background 0.3s, color 0.3s;
}
</style>
</head>
<body>
<header>
  <div class="header-left">
    <img src="assets/bhc-logo.png" alt="BHC Logo">
    <h1>BHC Library System</h1>
  </div>

  <div class="header-right">
    <button class="notif-btn" id="notifBtn" title="Notifications">🔔
      <span class="notif-badge" id="notifBadge" style="display:none">0</span>
    </button>
    <div class="notif-dropdown" id="notifDropdown">
      <div class="title">Notifications</div>
      <ul id="notifList"><li class="empty">No notifications</li></ul>
    </div>

    <div class="header-user" id="headerUser">Guest</div>
    <button id="darkToggle">🌙</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<nav class="sidebar" id="sidebarNav">
  <a href="#" onclick="showSection('dashboard')" data-section="dashboard" class="active">📊 Dashboard</a>
  <a href="#" onclick="showSection('books')" data-section="books">📚 Books</a>
  <a href="#" onclick="showSection('borrowers')" data-section="borrowers">👥 Borrowers</a>
  <a href="#" onclick="showSection('transactions')" data-section="transactions">📑 Transactions</a>
  <a href="#" onclick="showSection('admins')" data-section="admins">⚙ Admin Accounts</a>
  <a href="#" onclick="showSection('reports')" data-section="reports">📈 Reports</a>
</nav>

<main>
  <!-- Dashboard -->
  <section id="dashboard" class="active">
    <h2>📊 Summary</h2>
    <div class="stats">
      <div class="stat-box"><h3>Total Books</h3><p id="statBooks">0</p></div>
      <div class="stat-box"><h3>Borrowed</h3><p id="statBorrowed">0</p></div>
      <div class="stat-box"><h3>Available</h3><p id="statAvailable">0</p></div>
      <div class="stat-box"><h3>Overdue</h3><p id="statOverdue">0</p></div>
    </div>
  </section>

  <!-- Books -->
<section id="books">
  <h2>📚 Books Collection</h2>
  <form id="bookForm">
    <input type="hidden" id="editBookIndex">
    <input type="text" id="bookImage" placeholder="Image URL">
    <input type="text" id="bookTitle" placeholder="Book Title" required>
    <input type="text" id="bookAuthor" placeholder="Author" required>
    <input type="text" id="bookCategory" placeholder="Category">
    <button type="submit">➕ Add / Update Book</button>
  </form>

  <div style="margin-top:8px;">
    <input type="text" id="searchBook" class="search-box" placeholder="🔍 Search Book..." style="width:60%;">
    <select id="filterCategory" style="margin-left:8px; padding:8px; border-radius:6px;">
      <option value="">All categories</option>
    </select>
  </div>

<table>
  <thead>
    <tr>
      <th>Cover</th>
      <th>Title</th>
      <th>Author</th>
      <th>Category</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="bookList"></tbody>
</table>

</section>


<!-- Borrowers -->
<section id="borrowers">
  <h2>👥 Borrowers</h2>
  <form id="borrowerForm">
    <input type="hidden" id="editBorrowerIndex">

    <input type="text" id="borrowerName" placeholder="Borrower Name" required>
    <input type="text" id="borrowerID" placeholder="Student ID" required>
    <input type="text" id="borrowerCourse" placeholder="Course/Year" required>
    <input type="password" id="borrowerPin" placeholder="4-digit PIN" required maxlength="4">

    <button type="submit">➕ Add / Update Borrower</button>
  </form>
  
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>ID</th>
        <th>Course</th>
        <th>PIN</th>
        <th>History</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="borrowerList"></tbody>
  </table>
</section>


  <!-- Transactions -->
  <section id="transactions">
    <h2>📑 Transactions</h2>
    <form id="transactionForm">
      <select id="transactionBorrower" required style="min-width:200px;"></select>
      <select id="transactionBook" required style="min-width:200px;"></select>
      <button type="submit">📖 Borrow</button>
      <button type="button" id="returnBtn">↩ Return</button>
    </form>
    <ul id="transactionList" style="margin-top:12px;"></ul>
  </section>

  <!-- Admin Accounts -->
  <section id="admins">
    <h2>⚙ Manage Admin Accounts</h2>
    <form id="adminForm">
      <input type="text" id="adminUsername" placeholder="Username" required>
      <input type="password" id="adminPassword" placeholder="Password" required>
      <select id="adminRole" required>
        <option value="Super Admin">Super Admin</option>
        <option value="Librarian">Librarian</option>
        <option value="Staff">Staff</option>
        <option value="Viewer">Viewer</option>
      </select>
      <button type="submit">➕ Add Admin</button>
    </form>
    <table>
      <thead><tr><th>Username</th><th>Role</th><th>Action</th></tr></thead>
      <tbody id="adminList"></tbody>
    </table>
  </section>

  <!-- Reports -->
  <section id="reports">
    <h2>📊 Reports</h2>
    <div class="stats">
      <div class="stat-box"><h3>Total Borrowers</h3><p id="statTotalBorrowers">0</p></div>
      <div class="stat-box"><h3>Total Transactions</h3><p id="statTotalTransactions">0</p></div>
      <div class="stat-box"><h3>Returned</h3><p id="statReturned">0</p></div>
      <div class="stat-box"><h3>Overdue</h3><p id="statReportOverdue">0</p></div>
    </div>
    <h3>⚠ Overdue Books</h3>
    <ul id="overdueList"></ul>
    <h3>Borrowed vs Returned (Monthly)</h3>
    <canvas id="reportChart" style="max-width:600px;"></canvas>
    <div style="margin-top:12px;">
      <button class="export-btn" onclick="exportTransactions()">⬇ Export CSV</button>
      <button class="export-btn" onclick="exportPDF()">⬇ Export PDF</button>
      <button class="export-btn" onclick="exportJSON()">💾 Backup JSON</button>
      <input type="file" id="importFile" accept=".json" onchange="importJSON(event)">
    </div>
  </section>
</main>

<footer>© 2025 BHC Library System</footer>

<script>
/* ======================
   CONFIG
   ====================== */
const API = "http://localhost:3000/api";

let books = [];
let borrowers = [];
let transactions = [];
let admins = [];
let loggedInAdmin = JSON.parse(localStorage.getItem("loggedInAdmin")) 
  || { username: "admin", role: "Super Admin" };

/* ======================
   FETCH HELPERS
   ====================== */
async function fetchBooks() {
  const res = await fetch(`${API}/books`);
  books = await res.json();
  renderBooks();
  updateStats();
}
async function fetchBorrowers() {
  const res = await fetch(`${API}/borrowers`);
  borrowers = await res.json();
  renderBorrowers();
}
async function fetchTransactions() {
  const res = await fetch(`${API}/transactions`);
  transactions = await res.json();
  renderTransactions();
  updateStats();
}
async function fetchAdmins() {
  const res = await fetch(`${API}/admins`);
  admins = await res.json();
  renderAdmins();
}

/* ======================
   SAMPLE BOOKS SEED
   ====================== */
async function seedBooks() {
  if (books.length > 0) return;
  const sampleBooks = [
    { 
      title: "Noli Me Tangere", 
      author: "José Rizal", 
      category: "Classic",
      image: "https://covers.openlibrary.org/b/id/8231856-L.jpg"
    },
    { 
      title: "El Filibusterismo", 
      author: "José Rizal", 
      category: "Classic",
      image: "https://covers.openlibrary.org/b/id/10952756-L.jpg"
    },
    { 
      title: "Banaag at Sikat", 
      author: "Lope K. Santos", 
      category: "Novel",
      image: "https://covers.openlibrary.org/b/id/13148632-L.jpg"
    },
    { 
      title: "Mga Ibong Mandaragit", 
      author: "Amado V. Hernandez", 
      category: "Novel",
      image: "https://covers.openlibrary.org/b/id/10959572-L.jpg"
    },
    { 
      title: "Dekada ’70", 
      author: "Lualhati Bautista", 
      category: "Historical",
      image: "https://covers.openlibrary.org/b/id/9254994-L.jpg"
    },
    { 
      title: "Bulaklak sa City Jail", 
      author: "Lualhati Bautista", 
      category: "Novel",
      image: "https://upload.wikimedia.org/wikipedia/en/4/47/Bulaklak_sa_City_Jail_poster.jpg"
    }
  ];
  for (const b of sampleBooks) {
    await fetch(`${API}/books`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(b)
    }).catch(() => {});
  }
  await fetchBooks();
}


/* ======================
   BOOKS
   ====================== */
function renderBooks(filter = "") {
  const bookListEl = document.getElementById("bookList");
  const filterCategoryEl = document.getElementById("filterCategory");
  bookListEl.innerHTML = "";
  const catFilter = filterCategoryEl.value || "";

  const categories = new Set();
  books.filter(b => {
    const matchesText =
      (b.title || "").toLowerCase().includes(filter.toLowerCase()) ||
      (b.author || "").toLowerCase().includes(filter.toLowerCase());
    const matchesCat = !catFilter || (b.category === catFilter);
    return matchesText && matchesCat;
  }).forEach(book => {
    if (book.category) categories.add(book.category);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><img src="${book.image || 'https://via.placeholder.com/50'}" alt="cover" style="width:50px;height:auto;border-radius:4px;"></td>
      <td>${book.title}</td>
      <td>${book.author}</td>
      <td>${book.category || "-"}</td>
      <td>${book.status || "Available"}</td>
      <td>
        <button class="edit">✏ Edit</button>
        <button class="delete">🗑 Delete</button>
      </td>
    `;
    row.querySelector(".delete").addEventListener("click", async () => {
      if (!confirm("Delete this book?")) return;
      await fetch(`${API}/books/${book.id}`, { method: "DELETE" });
      fetchBooks();
    });
    row.querySelector(".edit").addEventListener("click", () => {
      document.getElementById("bookTitle").value = book.title;
      document.getElementById("bookAuthor").value = book.author;
      document.getElementById("bookCategory").value = book.category || "";
      document.getElementById("bookImage").value = book.image || "";
      document.getElementById("editBookIndex").value = book.id;
    });
    bookListEl.appendChild(row);
  });

  filterCategoryEl.innerHTML = '<option value="">All categories</option>';
  Array.from(categories).sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = c; opt.textContent = c;
    filterCategoryEl.appendChild(opt);
  });
}

document.getElementById("bookForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = document.getElementById("bookTitle").value.trim();
  const author = document.getElementById("bookAuthor").value.trim();
  const category = document.getElementById("bookCategory").value.trim();
  const image = document.getElementById("bookImage").value.trim();
  const idx = document.getElementById("editBookIndex").value;

  if (idx) {
    await fetch(`${API}/books/${idx}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, author, category, image })
    });
  } else {
    await fetch(`${API}/books`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, author, category, image })
    });
  }
  e.target.reset();
  fetchBooks();
});

/* ======================
   BORROWERS
   ====================== */
function renderBorrowers() {
  const borrowerListEl = document.getElementById("borrowerList");
  borrowerListEl.innerHTML = "";
  borrowers.forEach(b => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${b.name}</td>
      <td>${b.studentId}</td>
      <td>${b.course}</td>
      <td>****</td>
      <td>-</td>
      <td>
        <button class="edit">✏ Edit</button>
        <button class="delete">🗑 Remove</button>
      </td>
    `;
    borrowerListEl.appendChild(row);
  });
}

/* ======================
   TRANSACTIONS
   ====================== */
function renderTransactions() {
  const transactionListEl = document.getElementById("transactionList");
  transactionListEl.innerHTML = "";
  transactions.slice().reverse().forEach(t => {
    const li = document.createElement("li");
    li.textContent = `${t.studentId} ${t.type} bookID=${t.bookId} on ${t.date}`;
    transactionListEl.appendChild(li);
  });
}

/* ======================
   ADMINS
   ====================== */
function renderAdmins() {
  const adminListEl = document.getElementById("adminList");
  adminListEl.innerHTML = "";
  admins.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${a.username}</td><td>${a.role}</td><td>-</td>`;
    adminListEl.appendChild(tr);
  });
}

/* ======================
   DASHBOARD STATS
   ====================== */
function updateStats() {
  document.getElementById("statBooks").textContent = books.length;
  const borrowed = books.filter(b => b.status === "Borrowed").length;
  document.getElementById("statBorrowed").textContent = borrowed;
  document.getElementById("statAvailable").textContent = books.length - borrowed;
  const overdue = transactions.filter(t => t.type === "Overdue").length;
  document.getElementById("statOverdue").textContent = overdue;
}

/* ======================
   INIT
   ====================== */
async function init() {
  await fetchBooks();
  await fetchBorrowers();
  await fetchTransactions();
  await fetchAdmins();
  if (books.length === 0) await seedBooks();
}
init();

/* ======================
   UI HELPERS
   ====================== */
function showSection(id) {
  document.querySelectorAll("main section").forEach(sec => sec.classList.remove("active"));
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelector(`.sidebar a[data-section="${id}"]`).classList.add("active");
}

/* Dark mode */
document.getElementById("darkToggle").addEventListener("click", () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
});
if (localStorage.getItem("darkMode") === "true") {
  document.body.classList.add("dark");
}

/* Logout */
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("loggedInAdmin");
  window.location.href = "index.html";
});

/* Notifications dropdown */
const notifBtn = document.getElementById("notifBtn");
const notifDropdown = document.getElementById("notifDropdown");
notifBtn.addEventListener("click", () => {
  notifDropdown.style.display = notifDropdown.style.display === "block" ? "none" : "block";
});
window.addEventListener("click", (e) => {
  if (!notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
    notifDropdown.style.display = "none";
  }
});

/* Live search for books */
document.getElementById("searchBook").addEventListener("input", (e) => {
  renderBooks(e.target.value);
});

/* Refresh filter */
document.getElementById("filterCategory").addEventListener("change", () => {
  renderBooks(document.getElementById("searchBook").value);
});
</script>
</body>
</html>
